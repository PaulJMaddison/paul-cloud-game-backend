# paul-cloud-game-backend

Go monorepo for backend services powering `paul-cloud-game-backend`.

## Services

Each service builds and runs as a separate binary under `/cmd`:

- `gateway`: edge HTTP entrypoint
- `router`: internal request routing layer
- `login`: authentication/login flows
- `sessions`: session lifecycle management
- `matchmaking`: matchmaking orchestration

All services currently use shared bootstrap logic and expose:

- `GET /healthz` -> `200 ok`
- `GET /readyz` -> `200 ready`
- `GET /metrics` -> `501 metrics placeholder`

## Shared packages

- `pkg/config`: environment variable parsing and defaults
- `pkg/logging`: zerolog logger configured with
  - `app="paul-cloud-game-backend"`
  - `service="<name>"`
- `pkg/httpserver`: server helpers and health/ready/metrics handlers
- `pkg/storage`: `database/sql` setup with pgx + Redis client
- `pkg/bus`: NATS connection helper and event subjects

## Requirements

- Go 1.22+
- Docker + Docker Compose plugin

## Local development

1. Copy the sample env file and adjust values if needed:

   ```bash
   cp .env.example .env
   ```

2. Start local dependencies:

   ```bash
   make docker-up
   ```

3. Run DB migrations:

   ```bash
   make migrate-up
   ```

4. Run a service (example: gateway):

   ```bash
   make run-local
   ```

5. Verify health endpoint:

   ```bash
   curl -i http://localhost:8080/healthz
   ```

6. Run checks:

   ```bash
   make test
   make lint
   ```

7. Stop dependencies:

   ```bash
   make docker-down
   ```

## Environment variables

### App services

- `APP_NAME` (default: `paul-cloud-game-backend`)
- `APP_ENV` (default: `development`)
- `PORT` (default: `8080`)
- `POSTGRES_URL` (default: `postgres://postgres:postgres@localhost:5432/paul_cloud_game?sslmode=disable`)
- `REDIS_ADDR` (default: `localhost:6379`)
- `NATS_URL` (default: `nats://localhost:4222`)
- `SHUTDOWN_TIMEOUT_SECONDS` (default: `10`)

### Docker dependency services

- `POSTGRES_DB` (default: `paul_cloud_game`)
- `POSTGRES_USER` (default: `postgres`)
- `POSTGRES_PASSWORD` (default: `postgres`)

### Optional observability placeholders

- `GRAFANA_ADMIN_USER` (default: `admin`)
- `GRAFANA_ADMIN_PASSWORD` (default: `admin`)

## Database migrations

Migrations live in `deploy/sql/migrations` using paired files:

- `<version>.up.sql`
- `<version>.down.sql`

Run migrations with:

```bash
make migrate-up
make migrate-down
```

You can also call the migration command directly:

```bash
POSTGRES_URL=postgres://postgres:postgres@localhost:5432/paul_cloud_game?sslmode=disable go run ./cmd/migrate up
POSTGRES_URL=postgres://postgres:postgres@localhost:5432/paul_cloud_game?sslmode=disable go run ./cmd/migrate down -steps=1
```

## Make targets

- `make test`
- `make lint`
- `make build`
- `make run-local`
- `make docker-up`
- `make docker-down`
- `make migrate-up`
- `make migrate-down`

## Gateway WebSocket usage

The `gateway` service listens on `:8080` and exposes:

- `GET /v1/ws?token=<jwt>` for client WebSocket sessions
- `POST /v1/send` for internal message push

Quick test with `wscat`:

```bash
# TOKEN should be generated by login service (/v1/login)
export TOKEN="<jwt>"

# connect as the authenticated user
wscat -c "ws://localhost:8080/v1/ws?token=${TOKEN}"
```

From another terminal, push a message to that user:

```bash
curl -X POST http://localhost:8080/v1/send \
  -H 'Content-Type: application/json' \
  -d '{"user_id":"<user-id>","message":{"type":"notice","text":"hello from gateway"}}'
```

You should see the JSON message printed in the connected `wscat` session.
